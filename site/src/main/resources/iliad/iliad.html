<html lang="en">
  <head>
    <title>The Iliad</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <meta charset="utf-8" />
    <link href='http://fonts.googleapis.com/css?family=Cardo:400,700' rel='stylesheet' type='text/css'>
    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" />

    <style type='text/css'>
      body {
        font-family: 'Cardo', serif;
        line-height: 25px;
      }
      .prototype {
        display: none;
      }
      .text {
        margin-top: 55px;
      }
      .modal .modal-body {
        height: 400px;
      }
      .carousel {
        margin-top: 100px;
      }
      .carousel-inner .item {
        margin: 0 115px;
        height: 200px;
        overflow-y: scroll;
        width: 300px;
      }
      .carousel-inner .item p {
        text-align: center;
      }
      .carousel-inner .item > p {
        font-size: 200%;
      }
      .info-pane {
        padding: 0px 25px 10px 25px;
        margin-left: 0;
        position: fixed;
        overflow-y: scroll;
        height: 100%;
        background-color: #dad5ca; 
        border-left: 1px solid lightgray;
        z-index: 1040;
      }
      .info-pane-container {
        margin: 0;
        padding: 0;
      }
      ul.lexicon, ol.notes {
        display: none;
        list-style-type: none;
      }
      .info-pane li {
        list-style-type: lower-roman;
      }
      span.translation {
        font-weight: bold;
      }
      div.paragraph {
        margin-bottom: 15px;
      }
      div.line .row div.span1 {
        vertical-align: baseline;
        text-align: left;
        line-height: 20px !important;
      }
      div.line a.line-number {
        margin-left: 35px;
        font-size: 80%;
        padding: 1px 8px;
        -webkit-border-radius: 999px;
        -moz-border-radius: 999px;
        border-radius: 999px;
        vertical-align: baseline;
        line-height: 20px;
        display: inline-block;
      }
      div.line a.line-number:not(.highlight) {
        visibility: hidden;
        color: gray;
      }
      div.line a.line-number.five {
        visibility: visible;
      }
      div.line .row .words, div.line .row .span1 {
        position: relative;
      }
      div.line .row .words {
        /*margin-left: 28px;*/
        /*text-indent: -20px;*/
      }
      div.line:hover a.line-number.has-commentary:not(.highlight) {
        padding: 0px 7px;
        cursor: pointer;
        border: 1px solid gray;
      }
      div.line:hover a.line-number:not(.highlight) {
        visibility: visible !important;
      }
      .navbar {
        margin-left: 0;
        padding-left: 40px !important;
        background-color: #e5e0d4;
        -mozilla-box-shadow: 0 1px 10px rgba(0,0,0,0.1);
        -webkit-box-shadow: 0 1px 10px rgba(0,0,0,0.1);
        box-shadow: 0 1px 10px rgba(0,0,0,0.1);
      }
      .navbar-inner {
        background: inherit;
        border: none;
        -mozilla-box-shadow: none !important;
        -webkit-box-shadow: none !important;
        box-shadow: none !important;
      }
      caption {
        font-variant: small-caps;
      }
      .footer {
        text-align: center;
        padding: 30px 0;
        border-top: 1px solid gray;
      }
      .tooltip {
        z-index: 2000 !important;
      }
    </style>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-35516208-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="span6">
          <div class="navbar navbar-fixed-top span6">
            <div class="navbar-inner">
              <div class="container">
                <a class="brand" href="#">ILIAD</a>
                <ul class="nav">
                  <li>
                    <div class="btn-group">
                      <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                        Book <%= book %> <span class="caret"></span>
                      </a>
                      <ul class="dropdown-menu">
                        <% for (var i = 1; i <= 24; i++) { %>
                          <li><a href="/iliad/books/<%= i %>">Book <%= i %></a></li>
                        <% } %>
                      </ul>
                    </div>
                  </li>
                  <li><a class="range"><span class="start">1</span>..<span class="end"></a></li>
                  <li><a href="#" class="vocabulary">Vocabulary</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class='text'>
            <%= text %>
            <section class='footer span5'>
              <p>Data provided by <a id="thanks" data-toggle="tooltip" href="http://www.perseus.tufts.edu/hopper/" title="With special thanks to: Alex Lessie, James C. D'Amico, Brian Livingston, Calliopi Dourou, C. Dan Earley, Connor Hayden, Daniel Lim Libatique, Francis Hartel, George Matthews, J. F. Gentile, Jennifer Adams, Jessica Nord, Jennifer Curtin, Mary Ebbott, Meg Luthin, Molly Miller, Michael Kinney, Jack Mitchell, Sam Zukoff, Scott J. Dube, Tovah Keynton, W. B. Dolan">Perseus</a> under the <a href="http://creativecommons.org/licenses/by-sa/3.0/us/">CC License</a>.</p>
              <p>Designed and built by <a href="http://twitter.com/nk" target="_blank">@nk</a>.</p>
            </section>
          </div>
        </div>
        <div class='info-pane-container span6'>
          <div class="info-pane span6">
          <h4></h4>
          <h5></h5>
          <div class="content">
          </div>
        </div>
      </div>
    </div>
    <%= lexicon %>
    <%= notes %>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript">
    //<![CDATA[
      $(function() {
        var state = {highlighted: $(), styled: $()};
        var $notes = $('ol.notes');
        var i = 0;
        function reset() {
          $('.info-pane > h4').text('');
          $('.info-pane > h5').text('');
          $('.info-pane > .content').text('');
          state.highlighted.each(function() {
            $this = $(this);
            $this
              .data('original')
                .removeAttr('style')
            $this.remove();
          });
          state.highlighted = $();
        }
        function highlight($item) {
          var result = $();
          $item.each(function () {
            var $this = $(this);
            var position = $this.position();
            var $highlight = $this.clone();
            $highlight
              .css('position', 'absolute')
              .data('original', $this)
              .click(function() { $this.click() })
              .css('top', position.top)
              .css('left', position.left)
              .addClass('highlight')
              .appendTo($this.parent());
            $this.css('visibility', 'hidden');
            result = result.add($highlight);
            state.highlighted = state.highlighted.add($highlight);
          });
          return result;
        }
        function inflections($word) {
          return [
            $word.data('part-of-speech'),
            $word.data('person'),
            $word.data('number'),
            $word.data('tense'),
            $word.data('mood'),
            $word.data('voice'),
            $word.data('case'),
            $word.data('gender')
          ].filter(function(item) {return item}).join(', ')
        }

        $('a.line-number')
          .each(function() {
            var $this = $(this);
            if (++i % 5 == 0) $this.addClass('five');
            var $book = $this.parents('section.book');
            var $note = $notes.find('li[data-book="' + $book.data('number') + '"]').filter('[data-line="' + $this.text() + '"]');
            if ($note.length > 0) {
              $this
                .addClass('has-commentary')
                .data('note', $note)
            }
          })
          .click(function() {
            reset();
            var $this = $(this);
            var $note = $this.data('note');
            if ($note) {
              highlight($this).addClass('label').addClass('label-info');
              $('.info-pane > h4')
                .text('Book ' + $this.parents('section.book').data('number') + ", line " + $this.text());
              $('.info-pane .content')
                .html($note.html());
            }
          });

        $('span.word').click(function() {
          reset();
          var $currentWord = $(this);
          var lemma = $currentWord.data('lemma');

          var $currentEntry = $('ul.lexicon > li[data-lemma=' + lemma + ']');
          $('.info-pane > h4')
            .text(lemma);
          $('.info-pane > h5')
            .html("<span class='label'>" + $currentWord.text() + "</span> ")
            .append(inflections($currentWord));
          $('.info-pane .content').html($currentEntry.html())

          var $section  = $currentWord.parents('section.card').first();
          var $sentence = $section.find('span[data-sentence-id="' + $currentWord.data('sentence-id') + '"]');

          var $parent     = $currentWord;
          var parents     = [];
          while (($parent = $sentence.filter('span[data-id="' + $parent.data('parent-id') + '"]')) && $parent.length > 0) {
            parents.push($parent);
          }

          var bfs   = [$currentWord];
          var stack = [$currentWord];
          while (stack.length > 0) {
            var $current  = stack.pop();
            var level = $();
            $current.each(function() {
              $this = $(this);
              var $children = $sentence.filter('span[data-parent-id="' + $this.data('id') + '"]');
              level = level.add($children);
            });
            if (level.length > 0) {
              stack.push(level);
              bfs.push(level);
            }
          };

          var level = 0;
          bfs.forEach(function(nodes) {
            var opacity = 1.0 - level++ / bfs.length;
            highlight(nodes)
              .css('opacity', opacity)
              .addClass('label')
              .addClass('label-info');
          });
          level = 1; // pretend we skipped one
          parents.forEach(function(parent) {
            var opacity = 1.0 - (level++ / (parents.length + 1));
            highlight(parent)
              .css('opacity', opacity)
              .addClass('label')
              .addClass('label-important');
          });

          setTimeout(function() {
            highlight($('div.text span[data-lemma="' + lemma + '"]').not($currentWord)).addClass('label')
          }, 40)
        });
        $('body')
          .keydown(function(e) {
            if (e.which == 27) { // <ESC>
              $(".modal").modal('hide');
              reset();
            }
          });
        var offset = $('.text').css('margin-top').slice(0, -2);
        $('#thanks').tooltip();
        var params = {};
        window.location.search.slice(1).split('&').forEach(function(param) {
          var pair = param.split('=');
          params[pair[0]] = pair[1];
        });
        var start = Number(params.start), end = Number(params.end);
        $(".range .start").text((start || 1).toString());
        $(".range .end").text(end || "end");
        if (start) {
          $('html, body')
            .animate({
              scrollTop: $("div.line:eq(" + (start - 1) + ")").offset().top - offset
             }, 500);
        }
        $(window).scroll(function(e) {
          var line = $(document.elementFromPoint(0, offset)).find('> div.span1 > a.line-number').first();
          start = Number(line.text());
          if (line.length > 0) $('.range .start').text(start);
        })

        var $tablePrototype = $("#vocabulary table");
        var $carouselPrototype = $("#vocabulary #vocabulary-practice");
        $("a.vocabulary").click(function() {
          var $modalBody = $('#vocabulary .modal-body').empty();
          var vocabulary = {};
          $range = $("div.line").slice(start ? start - 1 : 0, end || undefined);
          $range.find('span.word').each(function() {
            var self = $(this), partOfSpeech;
            if (self.data('lemma')[0] == self.data('lemma')[0].toLowerCase()) { // skip proper nouns
              if (!vocabulary[self.data('part-of-speech')])
                vocabulary[self.data('part-of-speech')] = {};
              partOfSpeech = vocabulary[self.data('part-of-speech')];

              if (partOfSpeech[self.data('lemma')] === undefined) {
                partOfSpeech[self.data('lemma')] = {count: 1, words: {}};
                partOfSpeech[self.data('lemma')].words[self.text()] = {count: 1, word: self};
              } else {
                partOfSpeech[self.data('lemma')].count++;
                if (partOfSpeech[self.data('lemma')].words[self.text()] == undefined) {
                  partOfSpeech[self.data('lemma')].words[self.text()] = {count: 1, word: self};
                } else {
                  partOfSpeech[self.data('lemma')].words[self.text()].count++;
                }
              }
            }
          });

          var $carousel = $carouselPrototype.clone().appendTo($modalBody);
          ['noun', 'adjective', 'verb', 'participle', 'adverb'].forEach(function(key) {
            var $table = $tablePrototype.clone().removeClass("prototype").appendTo($modalBody);
            var $tbody = $table.find("tbody");
            var partOfSpeech = vocabulary[key];
            var lemmas = Object.keys(partOfSpeech).sort(function(a, b) { return partOfSpeech[b].count - partOfSpeech[a].count });
            $table.find("caption").text(key + " frequency");
            for (var i = 0; i < lemmas.length; i++) {
              if (i == (Number(params.limit || 30))) break;
              var lemma = lemmas[i];
              var words = partOfSpeech[lemma].words;
              var forms = Object.keys(words).sort(function(a, b) { return words[b].count - words[a].count });
              var definition = $('ul.lexicon > li[data-lemma=' + lemma + ']');
              $carousel.find(".carousel-inner")
                .append("<div class='item'><p>" + lemma + "</p><div class='carousel-caption'><p>" + forms.join(", ") + "</p></div></div>")
                .append("<div class='item'><p>" + definition.html() + "</p></div>");
              $("<tr><td>" + lemma + "</td><td>" + partOfSpeech[lemma].count + "</td></tr>")
                .append((function() {
                  var cell = $("<td></td>");
                  for (var i = 0; i < forms.length; i++) {
                    if (i == 3) break;

                    var span = words[forms[i]].word;
                    $("<span data-toggle='tooltip' title='" + inflections(span) + "'>" + span.text() + "</span>")
                      .appendTo(cell)
                      .tooltip();
                    if (i < 2 && i < forms.length - 1) cell.append(", ")
                  }
                  return cell;
                })())
                .append($("<td>" + definition.find(".translation:first").text() + "</td>"))
                .appendTo($tbody);
            }
          });
          $carousel.find(".item").first().addClass('active');
          $('#vocabulary').modal();
          return false;
        });
        $("#vocabulary .btn-primary").click(function() {
          $("#vocabulary .modal-body table").hide();
          $("#vocabulary-practice").show();
        });
        if (params.hasOwnProperty('vocabulary')) $("a.vocabulary").click();
      });
    //]]></script>
    <div class="modal hide fade" id="vocabulary">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Vocabulary Frequency <span class="range"><span class="start"></span>..<span class="end"></span></h3>
      </div>
      <div class="modal-body">
        <table class="table table-border prototype">
          <caption></caption>
          <thead>
            <tr><th>Lemma</th><th>Freq.</th><th>Common</th><th>Definition</th></tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <div id="vocabulary-practice" class="carousel slide hide">
          <div class="carousel-inner"></div>
          <a class="carousel-control left" href="#vocabulary-practice" data-slide="prev">&lsaquo;</a>
          <a class="carousel-control right" href="#vocabulary-practice" data-slide="next">&rsaquo;</a>
        </div>
      </div>
      <div class="modal-footer">
        <a href="#" class="btn btn-primary">Practice Vocabulary</a>
        <a href="#" class="btn" data-dismiss="modal">Close</a>
      </div>
    </div>
  </body>
</html>
