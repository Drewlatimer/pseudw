<html lang="en">
  <head>
    <title>The Iliad</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="Nick Kallen" />
    <meta charset="utf-8" />
    <link href='http://fonts.googleapis.com/css?family=Cardo:400,700' rel='stylesheet' type='text/css'>
    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet" />

    <style type='text/css'>
      body {
        font-family: 'Cardo', serif;
        line-height: 25px;
      }
      .prototype {
        display: none;
      }
      .well.info-well {
        background-color: #dad5ca;
        border: inherit;
      }
      .text {
        margin-top: 55px;
      }
      .modal .modal-body {
        height: 400px;
      }
      .modal h3 .book {
        font-size: 50%;
      }
      .carousel {
        margin-top: 100px;
      }
      .carousel-inner .item {
        margin: 0 115px;
        height: 200px;
        overflow-y: scroll;
        width: 300px;
      }
      .carousel-inner .item p {
        text-align: center;
      }
      .carousel-inner .item > p {
        font-size: 200%;
      }
      table td, table th {
        border: inherit !important;
      }
      @media (min-width: 980px) {
        .info-well {
          display: none;
        }
        .hidden-desktop {
          display: none;
        }
        div.line:hover a.line-number.has-commentary:not(.highlight) {
          padding: 0px 7px;
          cursor: pointer;
          border: 1px solid gray;
        }
        div.line:hover a.line-number:not(.highlight) {
          visibility: visible !important;
        }
      }
      @media (max-width: 979px) {
        .info-pane {
          display: none;
        }
        .hidden-phone {
          display: none;
        }
        body > .container, body > .container > .row {
          width: 480px;
        }
      }
      .info-pane {
        margin: 0;
        padding: 0;
        right: 0;
        top: 0;
        position: fixed;
        background-color: #dad5ca; 
        z-index: 1040;
        width: 500px;
        height: 100%;
        overflow-y: scroll;
      }
      .info-pane .container {
        padding: 0px 25px 10px 25px;
        margin-left: 0;
        border-left: 1px solid lightgray;
      }
      ul.lexicon, ol.notes {
        display: none;
        list-style-type: none;
      }
      .info-pane li {
        list-style-type: lower-roman;
      }
      span.translation {
        font-weight: bold;
      }
      div.paragraph {
        margin-bottom: 15px;
      }
      div.line .row div.span1 {
        vertical-align: baseline;
        text-align: left;
        line-height: 20px !important;
      }
      div.line a.line-number {
        margin-left: 25px;
        font-size: 80%;
        padding: 1px 8px;
        -webkit-border-radius: 999px;
        -moz-border-radius: 999px;
        border-radius: 999px;
        vertical-align: baseline;
        line-height: 20px;
        display: inline-block;
      }
      div.line a.line-number:not(.highlight) {
        visibility: hidden;
        color: gray;
      }
      div.line a.line-number.five {
        visibility: visible;
      }
      div.line .row .words, div.line .row .span1 {
        position: relative;
      }
      a.vocabulary {
        cursor: pointer;
      }
      .navbar {
        margin-left: 0;
        padding-left: 40px !important;
        background-color: #e5e0d4;
        -mozilla-box-shadow: 0 1px 10px rgba(0,0,0,0.1);
        -webkit-box-shadow: 0 1px 10px rgba(0,0,0,0.1);
        box-shadow: 0 1px 10px rgba(0,0,0,0.1);
      }
      .navbar-inner {
        background: inherit;
        border: none;
        -mozilla-box-shadow: none !important;
        -webkit-box-shadow: none !important;
        box-shadow: none !important;
      }
      .navbar input {
        margin-bottom: 0;
      }
      thead td.caption {
        font-variant: small-caps;
        text-align: center;
      }
      .footer {
        text-align: center;
        padding: 30px 0;
        border-top: 1px solid gray;
      }
      .tooltip {
        z-index: 2000 !important;
      }
    </style>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-35516208-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <div class="container">
      <div class="navbar navbar-fixed-top">
        <div class="navbar-inner">
          <div class="container">
            <a class="brand" href="#">ILIAD</a>
            <ul class="nav">
              <li>
                <div class="btn-group">
                  <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                    Book <%= book %> <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu">
                    <% for (var i = 1; i <= 24; i++) { %>
                      <li><a href="/iliad/books/<%= i %>">Book <%= i %></a></li>
                    <% } %>
                  </ul>
                </div>
              </li>
              <li><a class="range"><input type="text" class="start input-mini" value="1" />..<input type="text" class="end input-mini" /></a></li>
              <li><a class="vocabulary">Vocabulary</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class='text'>
        <%= text %>
        <section class='footer span5'>
          <p>Data provided by <a id="thanks" data-toggle="tooltip" href="http://www.perseus.tufts.edu/hopper/" title="With special thanks to: Alex Lessie, James C. D'Amico, Brian Livingston, Calliopi Dourou, C. Dan Earley, Connor Hayden, Daniel Lim Libatique, Francis Hartel, George Matthews, J. F. Gentile, Jennifer Adams, Jessica Nord, Jennifer Curtin, Mary Ebbott, Meg Luthin, Molly Miller, Michael Kinney, Jack Mitchell, Sam Zukoff, Scott J. Dube, Tovah Keynton, W. B. Dolan">Perseus</a> under the <a href="http://creativecommons.org/licenses/by-sa/3.0/us/">CC License</a>.</p>
          <p>Designed and built by <a href="http://twitter.com/nk" target="_blank">@nk</a>.</p>
        </section>
      </div>
      <div class='info-pane'>
        <div class="container span5">
          <h4></h4>
          <h5></h5>
          <div class="content"></div>
        </div>
      </div>
      <div class='well info-well prototype'>
        <h4></h4>
        <h5></h5>
        <div class='content'></div>
      </div>
    </div>
    <%= lexicon %>
    <%= notes %>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript">
    //<![CDATA[
      $(function() {
        var state = $();
        var $notes = $('ol.notes');
        var i = 0;
        var $infoPane = $('.info-pane');
        var $infoWell = $('.info-well').removeClass('prototype');
        var $info = $infoPane.add($infoWell);
        function reset() {
          $info.find('h4').text('');
          $info.find('h5').text('');
          $info.find('.content').text('');
          $infoWell.remove();
          state.each(function() {
            $this = $(this);
            $($this.data('original')) // hack
                .removeAttr('style')
            $this.remove();
          });
          state = $();
        }
        reset();
        function highlight($item) {
          var result = $();
          $item.each(function () {
            var $this = $(this);
            var position = $this.position();
            var $highlight = $this.clone();
            $highlight
              .css('position', 'absolute')
              .data('original', $this)
              .click(function() { $this.click() })
              .css('top', position.top)
              .css('left', position.left)
              .addClass('highlight')
              .appendTo($this.parent());
            $this.css('visibility', 'hidden');
            result = result.add($highlight);
            state = state.add($highlight);
          });
          return result;
        }
        function inflections($word) {
          return [
            $word.data('part-of-speech'),
            $word.data('person'),
            $word.data('number'),
            $word.data('tense'),
            $word.data('mood'),
            $word.data('voice'),
            $word.data('case'),
            $word.data('gender')
          ].filter(function(item) {return item}).join(', ')
        }
        var fudge = 5; // for descenders;
        var offset = Number($('.text').css('margin-top').slice(0, -2)) - fudge;
        function scrollTo(line) {
          $('html, body')
            .animate({
              scrollTop: $("div.line:eq(" + (line - 1) + ")").offset().top - offset
             }, 500);
        }

        $('a.line-number')
          .each(function() {
            var $this = $(this);
            if (++i % 5 == 0) $this.addClass('five');
            var $book = $this.parents('section.book');
            var $note = $notes.find('li[data-book="' + $book.data('number') + '"]').filter('[data-line="' + $this.text() + '"]');
            if ($note.length > 0) {
              $this
                .addClass('has-commentary')
                .data('note', $note)
            }
          })
        $('.line .span1')
          .click(function() {
            reset();
            var $this = $(this);
            var $row = $this.parents(".row");
            var $lineNumber = $this.find('.line-number');
            var $note = $lineNumber.data('note');
            if ($note) {
              highlight($lineNumber).addClass('label').addClass('label-info').click(function() {
                reset();
                return false;
              });
              $info.find('h4')
                .text('Book ' + $this.parents('section.book').data('number') + ", line " + $this.text());
              $info.find('.content')
                .html($note.html());
              $row.after($infoWell);
            }
          });

        var $lexicon = $("ul.lexicon > li");
        var lexicon = {};
        $lexicon.each(function() {
          var $this = $(this);
          lexicon[$this.data('lemma')] = $this;
        })
        $('.words span').click(function() {
          reset();
          var $word = $(this);
          var $row = $word.parents(".row");
          var lemma = $word.data('lemma');

          var $translation = lexicon[lemma];
          $info.find('h4').text(lemma);
          $info.find('h5')
            .html("<span class='label'>" + $word.text() + "</span> ")
            .append(inflections($word));
          $info.find('.content').html($translation.html());
          $row.after($infoWell);

          var $section  = $word.parents('section.card').first();
          var $sentence = $section.find('span[data-sentence-id="' + $word.data('sentence-id') + '"]');

          var $parent     = $word;
          var parents     = [];
          while (($parent = $sentence.filter('span[data-id="' + $parent.data('parent-id') + '"]')) && $parent.length > 0) {
            parents.push($parent);
          }

          var bfs   = [$word];
          var stack = [$word];
          while (stack.length > 0) {
            var $current  = stack.pop();
            var level = $();
            $current.each(function() {
              $this = $(this);
              var $children = $sentence.filter('span[data-parent-id="' + $this.data('id') + '"]');
              level = level.add($children);
            });
            if (level.length > 0) {
              stack.push(level);
              bfs.push(level);
            }
          };

          highlight($word)
            .addClass('label').addClass('label-info')
            .off('click')
            .click(reset);
          bfs.shift();
          var level = 1; // pretend we skipped one
          bfs.forEach(function(nodes) {
            var opacity = 1.0 - level++ / (bfs.length + 1);
            highlight(nodes)
              .css('opacity', opacity)
              .addClass('label')
              .addClass('label-info');
          });
          level = 1; // pretend we skipped one
          parents.forEach(function(parent) {
            var opacity = 1.0 - (level++ / (parents.length + 1));
            highlight(parent)
              .css('opacity', opacity)
              .addClass('label')
              .addClass('label-important');
          });

          setTimeout(function() {
            highlight($('div.text span[data-lemma="' + lemma + '"]').not($word)).addClass('label')
          }, 10)
        });
        $('body')
          .keydown(function(e) {
            if (e.which == 27) { // <ESC>
              $(".modal").modal('hide');
              reset();
            }
          });
        $('#thanks').tooltip();
        var params = {};
        window.location.search.slice(1).split('&').forEach(function(param) {
          var pair = param.split('=');
          params[pair[0]] = pair[1];
        });
        var start, end = params.end || "";
        $(".range .end").val(end);
        if (start = Number(params.start)) {
          scrollTo(start);
        }
        var $start = $('.range input.start'), $end = $('.range input.end');
        $(window).scroll(function(e) {
          var leftOffset = $(".text").offset().left;
          var $line = $(document.elementFromPoint(leftOffset, offset + fudge)).not("section").find('a.line-number').first();
          if ($line.length > 0) {
            var lineNumber = Number($line.text());
            $start.val(lineNumber).text(lineNumber);
            var end = Math.max(lineNumber, Number($end.val()));
            $end.val(end).text(end);
          }
        })

        var $tableProto = $("#vocabulary table");
        var $carouselPrototype = $("#vocabulary #vocabulary-practice");
        var $theadProto = $("<thead><tr><td colspan='4' class='caption'></td></tr><tr><th>Lemma</th><th>Freq.</th><th>Common</th><th>Definition</th></tr></thead>");
        var $modalBody = $modalBody = $('#vocabulary .modal-body');
        var $lastLine = $(".line-number:last");
        $("a.vocabulary").click(function() {
          $modalBody.empty();
          $table = $tableProto.clone().appendTo($modalBody).removeClass("prototype");
          var vocabulary = {};
          var start = Number($start.val()) || 1;
          var end = Number($end.val() || $lastLine.text());
          $("#vocabulary .start").text(start);
          $("#vocabulary .end").text(end);
          $range = $("div.line").slice(start ? start - 1 : 0, end || undefined);
          $range.find('.words > span').each(function() {
            var self = $(this), wordsByPartOfSpeech;
            if (self.data('lemma')[0] == self.data('lemma')[0].toLowerCase()) { // skip proper nouns
              var partOfSpeech = self.data('part-of-speech');
              if (!vocabulary[partOfSpeech])
                vocabulary[partOfSpeech] = {};
              wordsByPartOfSpeech = vocabulary[partOfSpeech];
              var lemma = self.data('lemma');
              var text = self.text();

              if (wordsByPartOfSpeech[lemma] === undefined) {
                wordsByPartOfSpeech[lemma] = {count: 1, words: {}};
                wordsByPartOfSpeech[lemma].words[text] = {count: 1, word: self};
              } else {
                wordsByPartOfSpeech[lemma].count++;
                if (wordsByPartOfSpeech[lemma].words[text] == undefined) {
                  wordsByPartOfSpeech[lemma].words[text] = {count: 1, word: self};
                } else {
                  wordsByPartOfSpeech[lemma].words[text].count++;
                }
              }
            }
          });

          var $carousel = $carouselPrototype.clone().appendTo($modalBody);
          ['noun', 'adjective', 'verb', 'participle', 'adverb'].forEach(function(key) {
            var partOfSpeech = vocabulary[key];
            if (!partOfSpeech) return;

            var $thead = $theadProto.clone().appendTo($table);
            var $tbody = $("<tbody></tbody>").appendTo($table);
            var $caption = $thead.find(".caption");

            var lemmas = Object.keys(partOfSpeech).sort(function(a, b) { return partOfSpeech[b].count - partOfSpeech[a].count });
            $caption.text(key + " frequency");
            for (var i = 0; i < lemmas.length; i++) {
              if (i == (Number(params.limit || 30))) break;
              var lemma = lemmas[i];
              var words = partOfSpeech[lemma].words;
              var forms = Object.keys(words).sort(function(a, b) { return words[b].count - words[a].count });
              var $definition = $(lexicon[lemma]);
              $carousel.find(".carousel-inner")
                .append("<div class='item'><p>" + lemma + "</p><div class='carousel-caption'><p>" + forms.join(", ") + "</p></div></div>")
                .append("<div class='item'><p>" + $definition.html() + "</p></div>");
              $("<tr><td>" + lemma + "</td><td>" + partOfSpeech[lemma].count + "</td></tr>")
                .append((function() {
                  var cell = $("<td></td>");
                  for (var i = 0; i < forms.length; i++) {
                    if (i == 3) break;

                    var span = words[forms[i]].word;
                    $("<span data-toggle='tooltip' title='" + inflections(span) + "'>" + span.text() + "</span>")
                      .appendTo(cell);
                    if (i < 2 && i < forms.length - 1) cell.append(", ")
                  }
                  return cell;
                })())
                .append($("<td>" + $definition.find(".translation:first").text() + "</td>"))
                .appendTo($tbody);
            }
          });
          $carousel.find(".item").first().addClass('active');
          $table.find("span[data-toggle]").tooltip();
          $('#vocabulary').modal();
          return false;
        });
        $(".range input.start")
          .keypress(function(e) {
            if (e.which == 13) {
              var line = Number($(this).val());
              if (line) scrollTo(line);
            }
          })
          .blur(function(e) {
            var line = Number($(this).val());
          });
        $("#vocabulary .btn-primary").click(function() {
          $("#vocabulary .modal-body table").hide();
          $("#vocabulary-practice").show();
          return false;
        });
        if (params.hasOwnProperty('vocabulary')) $("a.vocabulary").click();
      });
    //]]></script>
    <div class="modal hide fade" id="vocabulary">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Vocabulary Frequency, <span class="book">Book <%= book %>, <span class="range"><span class="start"></span>-<span class="end"></span></span></h3>
      </div>
      <div class="modal-body">
        <table class="table table-border prototype">
        </table>
        <div id="vocabulary-practice" class="carousel slide hide">
          <div class="carousel-inner"></div>
          <a class="carousel-control left" href="#vocabulary-practice" data-slide="prev">&lsaquo;</a>
          <a class="carousel-control right" href="#vocabulary-practice" data-slide="next">&rsaquo;</a>
        </div>
      </div>
      <div class="modal-footer">
        <a href="#" class="btn btn-primary">Practice Vocabulary</a>
        <a href="#" class="btn" data-dismiss="modal">Close</a>
      </div>
    </div>
  </body>
</html>
